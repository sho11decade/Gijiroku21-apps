# Gijiroku21

## バックエンド（コア）要件定義書

**Version 1.0**

---

## 1. 目的・位置づけ

### 1.1 本書の目的

本書は、Gijiroku21 における **バックエンド（Core Engine）** の
機能要件・非機能要件・技術要件・制約条件を明確化し、
**実装・保守・拡張が可能な設計指針**を定義することを目的とする。

### 1.2 バックエンドの役割

バックエンドは以下を担う。

* 音声入力の取得・管理
* 音声認識（Whisper ONNX）推論
* トークナイズ・後処理
* リアルタイム文字起こし制御
* 議事録データの生成・保存
* フロントエンド（React）との通信

---

## 2. システム範囲

### 2.1 含まれる範囲

* ローカル音声処理
* ローカルAI推論
* ローカルデータ管理
* localhost API 提供

### 2.2 含まれない範囲

* クラウド連携
* ユーザー認証
* 外部API通信
* UIレンダリング

---

## 3. 基本要件（Functional Requirements）

### 3.1 音声入力管理

#### 要件

* PC内蔵マイク・外部マイクに対応
* 音声をリアルタイムで取得可能
* サンプリングレート変換（16kHz対応）

#### 詳細

* 音声は一定時間（例：数秒）ごとにバッファリング
* 音声データは WAV 形式で内部処理

---

### 3.2 音声認識（ASR）

#### 要件

* Whisper small 相当の精度
* ONNX Runtime による推論
* オフライン動作必須

#### 技術要件

* Encoder + Decoder を統合した単一 ONNX モデル
* Tokenizer はローカルファイルからロード
* 推論バックエンド：

  * 優先：NPU
  * 次点：CPU

---

### 3.3 リアルタイム文字起こし制御

#### 要件

* 音声取得 → 推論 → テキスト出力を継続的に実行
* フロントエンドに逐次結果を送信
* 発話遅延を最小限に抑制

#### 振る舞い

* 確定テキストと暫定テキストを区別
* 中断（Pause）／再開（Resume）対応

---

### 3.4 テキスト後処理

#### 要件

* 日本語向け整形処理

  * 句読点補完
  * 不要な空白除去
* 文単位での分割

#### 将来拡張

* 話者分離タグ付与
* キーワード抽出

---

### 3.5 議事録データ生成

#### 要件

* 会議単位でデータを管理
* 以下を保存：

  * 生音声（任意）
  * 文字起こし全文
  * 要約（将来）

---

## 4. API要件（フロントエンド連携）

### 4.1 通信方式

* localhost HTTP API
* JSON ベース
* FastAPI 使用

### 4.2 主な API（例）

| エンドポイント              | 機能      |
| -------------------- | ------- |
| `/status`            | AI状態取得  |
| `/record/start`      | 録音開始    |
| `/record/stop`       | 録音停止    |
| `/transcript/stream` | 逐次文字起こし |
| `/meeting/save`      | データ保存   |

---

## 5. 非機能要件（Non-Functional Requirements）

### 5.1 パフォーマンス

* 会議中の CPU 使用率を抑制
* 長時間（1時間以上）連続動作可能
* 推論遅延は数秒以内

### 5.2 プライバシー

* 音声・テキストは外部送信しない
* ネットワーク遮断環境でも動作

### 5.3 安定性

* マイク切断時もクラッシュしない
* 推論エラー時は安全に停止

---

## 6. 技術要件

### 6.1 実装言語・環境

| 項目   | 内容                    |
| ---- | --------------------- |
| 言語   | Python 3.10 以上        |
| 推論   | ONNX Runtime          |
| 音声   | sounddevice / pyaudio |
| API  | FastAPI               |
| 実行形式 | PyInstaller（exe化）     |

---

### 6.2 モデル管理

* モデルはアプリ同梱
* ネットワークダウンロード不要
* バージョン管理可能な構造

---

## 7. データ管理要件

### 7.1 保存構造（例）

```
Documents/Gijiroku21/
├─ meetings/
│  └─ YYYY-MM-DD/
│     ├─ audio.wav
│     ├─ transcript.txt
│     └─ meta.json
└─ config.json
```

### 7.2 データ方針

* 人が読める形式
* ユーザーが自由にバックアップ可能

---

## 8. エラーハンドリング・ログ

### 8.1 ログ要件

* 音声内容はログに含めない
* 処理状態・エラーコードのみ記録

### 8.2 エラー対応

* UIにわかりやすい状態コードを返却
* 自動復旧を優先

---

## 9. 制約条件

* 初期対応 OS：Windows
* NPU は存在すれば利用、必須ではない
* リアルタイム性と精度のバランスを優先

---

## 10. 将来拡張を考慮した設計方針

* モデル差し替え可能
* API追加が容易
* NPUベンダー別最適化を後付け可能

---

## 11. 成功条件（バックエンド視点）

* UIからワンクリックで録音開始
* 長時間会議で停止しない
* オフライン環境で完全動作

---

## 12. 実装状況（2025年12月）

### 12.1 完了（バックエンドコア）
- [x] FastAPI + Pydantic の基本骨格
- [x] 共通レスポンス型 `{ success, data, error }`
- [x] 音声入力管理：sounddevice + PCM キュー（fallback 対応）
- [x] ASR：tokenizer.json ロード + log-mel 変換 + ONNX グリーディデコード
- [x] リアルタイム文字起こし：SSE で partial/final/status 配信
- [x] 議事録データ管理：meeting meta (開始、終了、duration、タイトル) 自動保存
- [x] デバイス判定：onnxruntime providers 解析
- [x] ダミーモード：環境変数で全機能 fallback

### 12.2 今後実装予定（優先順）
- [ ] Transcript 完全文保存（transcript.txt）
- [ ] 要約生成・保存（summary.md）- 将来は LLM で自動化
- [ ] テキスト後処理：日本語整形、句読点補完
- [ ] `/export` エンドポイント (TXT/Markdown)
- [ ] ロギング強化（エラーコード、処理時間）
- [ ] 長時間録音テスト・メモリ最適化

### 12.3 長期（フェーズ2以降）
- [ ] 話者分離 / 識別タグ付与
- [ ] 決定事項・ToDo 自動抽出
- [ ] 複数言語モデル対応
- [ ] NPU ベンダー別最適化エンジン

---

## 付記

本バックエンドは
**「ユーザーに意識させないAI」**を実現するため、
派手さより **安定性・信頼性・静かな知性** を最優先とする。